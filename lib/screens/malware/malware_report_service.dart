import 'package:hive/hive.dart';
import 'package:http/http.dart' as http;
import 'dart:convert';
import 'package:connectivity_plus/connectivity_plus.dart';

import '../../models/malware_report_model.dart';
import '../../models/scam_report_model.dart';
import '../../config/api_config.dart';

class MalwareReportService {
  static final _box = Hive.box<MalwareReportModel>('malware_reports');



  static Future<void> saveReport(MalwareReportModel report) async {
    final connectivity = await Connectivity().checkConnectivity();
    if (connectivity != ConnectivityResult.none) {
      // Try to send to backend
      bool success = await sendToBackend(report);
      if (success) {
        report.isSynced = true;
      }
    }
    // Always save to local storage
    await _box.add(report);
  }

  static Future<void> syncReports() async {
    final box = Hive.box<MalwareReportModel>('malware_reports');
    final reports = box.values.toList();
    for (int i = 0; i < reports.length; i++) {
      final report = reports[i];
      if (!report.isSynced) {
        try {
          final response = await http.post(
            Uri.parse('${ApiConfig.baseUrl}malware-reports'),
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json',
            },
            body: jsonEncode({
              'malwareType': report.malwareType,
              'infectedDeviceType': report.infectedDeviceType,
              'operatingSystem': report.operatingSystem,
              'detectionMethod': report.detectionMethod,
              'location': report.location,
              'name': report.name, // Fixed: was report.type
              'systemAffected': report.systemAffected,
              'alertSeverityLevel': report.alertSeverityLevel,
              'fileName': report.fileName,
              'date': report.date.toIso8601String(),
              'id': report.id,
            }),
          );

          print('Sync response status: ${response.statusCode}');
          print('Sync response body: ${response.body}');

          if (response.statusCode == 200 || response.statusCode == 201) {
            // Update as synced
            final key = box.keyAt(i);
            final syncedReport = MalwareReportModel(
              id: report.id,
              malwareType: report.name,
              infectedDeviceType: report.infectedDeviceType,
              operatingSystem: report.operatingSystem,
              detectionMethod:  report.detectionMethod,
              location:  report.location,
              fileName: report.fileName,
              name: report.name,
              systemAffected: report.systemAffected,
              alertSeverityLevel: report.alertSeverityLevel,
              date: report.date,
            );
            await box.put(key, syncedReport);
            print('Successfully synced report: ${report.id}');
          } else {
            print(
              'Failed to sync report. Status: ${response.statusCode}, Body: ${response.body}',
            );
          }
        } catch (e) {
          print('Error syncing report: $e');
        }
      }
    }
  }

  static Future<bool> sendToBackend(MalwareReportModel report) async {
    try {
      final response = await http.post(
        Uri.parse('${ApiConfig.baseUrl}malware-reports'),
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
        },
        body: jsonEncode({
          'malwareType': report.malwareType,
          'infectedDeviceType': report.infectedDeviceType,
          'operatingSystem': report.operatingSystem,
          'detectionMethod': report.detectionMethod,
          'location': report.location,
          'name': report.name, // Fixed: was report.type
          'systemAffected': report.systemAffected,
          'alertSeverityLevel': report.alertSeverityLevel,
          'fileName': report.fileName,
          'date': report.date.toIso8601String(),
          'id': report.id,
        }),
      );

      print('Send to backend response status: ${response.statusCode}');
      print('Send to backend response body: ${response.body}');

      return response.statusCode == 200 || response.statusCode == 201;
    } catch (e) {
      print('Error sending to backend: $e');
      return false;
    }
  }

  static List<MalwareReportModel> getLocalReports() {
    return _box.values.toList();
  }
}
